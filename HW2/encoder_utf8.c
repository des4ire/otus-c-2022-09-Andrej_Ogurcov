#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdlib.h>

	static int cp1251[ 256 ] = {
		0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,
		31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,
		59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,
		87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,
		111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,1026,1027,8218,
		1107,8222,8230,8224,8225,8364,8240,1033,8249,1034,1036,1035,1039,1106,8216,8217,
		8220,8221,8226,8211,8212,8250,8482,1113,8250,1114,1116,1115,1119,160,1038,1118,1032,
		164,1168,166,167,1025,169,1028,171,172,173,174,1031,176,177,1030,1110,1169,181,182,
		183,1105,8470,1108,187,1112,1029,1109,1111,1040,1041,1042,1043,1044,1045,1046,1047,
		1048,1049,1050,1051,1052,1053,1054,1055,1056,1057,1058,1059,1060,1061,1062,1063,
		1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,1078,1079,
		1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,1090,1091,1092,1093,1094,1095,
		1096,1097,1098,1099,1100,1101,1102,1103
	};
	static int koi8r[ 256 ] = {
		0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,
		31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,
		59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,
		87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,
		111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127, 9472, 9474, 9484, 
		9488, 9492, 9496, 9500, 9508, 9516, 9524, 9532, 9600, 9604, 9608, 9612, 9616, 9617, 
		9618, 9619, 8992, 9632, 8729, 8730, 8776, 8804, 8805, 160, 8993, 176, 178, 183, 247, 
		9552, 9553, 9554, 1105, 9555, 9556, 9557, 9558, 9559, 9560, 9561, 9562, 9563, 9564, 9565, 
		9566, 9567, 9568, 9569, 1025, 9570, 9571, 9572, 9573, 9574, 9575, 9576, 9577, 9578, 9579, 
		9580, 169, 1102, 1072, 1073, 1094, 1076, 1077, 1092, 1075, 1093, 1080, 1081, 1082, 1083, 1084, 
		1085, 1086, 1087, 1103, 1088, 1089, 1090, 1091, 1078, 1074, 1100, 1099, 1079, 1096, 1101, 1097, 
		1095, 1098, 1070, 1040, 1041, 1062, 1044, 1045, 1060, 1043, 1061, 1048, 1049, 1050, 1051, 1052, 
		1053, 1054, 1055, 1071, 1056, 1057, 1058, 1059, 1046, 1042, 1068, 1067, 1047, 1064, 1069, 1065, 1063, 1066
		};
	static int iso8859_5[ 256 ] = {
		0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,
		31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,
		59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,
		87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,
		111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127, 128, 129, 130, 131, 132, 133, 134, 135, 
		136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 
		154, 155, 156, 157, 158, 159, 160, 1025, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1034, 1035, 1036, 173, 1038, 1039, 
		1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047, 1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059, 1060, 
		1061, 1062, 1063, 1064, 1065, 1066, 1067, 1068, 1069, 1070, 1071, 1072, 1073, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 
		1082, 1083, 1084, 1085, 1086, 1087, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 
		1103, 8470, 1105, 1106, 1107, 1108, 1109, 1110, 1111, 1112, 1113, 1114, 1115, 1116, 167, 1118, 1119
		};
	
	
//
void encode( char *out, char *in, int *charmap) {
       
	
	int cnt = strlen(in),
	i = 0, j = 0;
        
	for(; i < cnt; ++i ) {
		long c = charmap[(unsigned char) in[ i ]];
		if( c < 0x80 ) {
			out[ j++ ] = c;
		}
		else if( c < 0x800 ) {
			out[ j++ ] = (((c >> 6) & 0x1F) | 0xC0);
			out[ j++ ] = (((c >> 0) & 0x3F) | 0x80);
		
		} 
		else if( c < 0x10000 ) {
			out[ j++ ] = (c >> 12) | 0xe0;
			out[ j++ ] = (c >> 6) & (0x3f | 0x80);
			out[ j++ ] = (c & 0x3f) | 0x80;
		
		} 
	}
	out[ j ] = '\0';
}


  int main ( int argc, char *argv[] ) {

 

  int *charset;
  char buf[4], in[2] = {0, 0};
  int c=0;
  int i=0;

                
               
  if ( argc != 4 ) 
    {

        //printf( "usage: %s filename", argv[0] );
	printf("Usage: %s <input_file> <output_file> <encoding>", argv[0]); 
	printf("\n Available encodings: cp1251, koi8-r, iso-8859-5\n");
    }
    else
    {
        // We assume argv[1] is a filename to open
        FILE *file = fopen( argv[1], "rb" ); //файл для чтения
        	FILE *file_w = fopen( argv[2] , "wb" ); //файл для записи
			if ( file_w == 0 )
        		{
            		printf( "Could not open file for writing\n" );
        		}
        /* fopen returns 0, the NULL pointer, on failure */
        if ( file == 0 )
        {
            printf( "Could not open file for reading\n" );
        }
        else
        {

		if (strcmp(argv[3], "cp1251") == 0)
			{
            		charset=cp1251;
        		}
       		else if (strcmp(argv[3], "koi8-r") == 0)
			{
			charset=koi8r;
        		} 
		else if (strcmp(argv[3], "iso-8859-5") == 0)
			{
			charset=iso8859_5;
        		} 
		else    
			{
			printf("\nEncoding is not supported. Valid encodings: cp1251, koi8-r, iso-8859-5\n");
			exit(0);
			};

	while  ( ( c = fgetc( file ) ) != EOF )
            {
		i++;
                *in = c;
		
            		encode(buf, in, charset);
        	
		fputs(buf, file_w );               
		printf("%s",buf);

            }
            fclose( file );
   		fclose(file_w);     

        }
    }
}



   